define(["order!underscore","order!backbone","order!raphael","order!jquery","constants","node","nodes","nodeview","connector","connectors","connectorview","sprite","sprites","spriteview","startbuttonview"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=null,q=b.View.extend({initialize:function(){var f=this;f.paper=c("board",e.boardWidth,e.boardHeight),f.el=f.paper.canvas,f.$el=d(f.el),f.offset=f.$el.offset(),f.nodes=new g,f.nodes.on("add",f.nodeAdded,f),f.connectors=new j,f.connectors.on("add",f.connectorAdded,f),f.allSprites=new m,f.activeSprites=new m,f.markers=new g,f.finishedSprites=new m,f.finishedSprites.on("add",f.spriteFinished,f),f.dispatcher=a.clone(b.Events),d("body").on("mouseup",a.bind(f.cursorUp,f)),d("body").on("touchend",a.bind(f.cursorUp,f));var h=new o({board:this})},events:{mousemove:"cursorMove",touchmove:"cursorMove",touchend:"touchEnd",touchstart:function(a){a.preventDefault()}},load:function(a,b){var c=this;c.allSprites.destroyAll(),c.nodes.destroyAll(),c.connectors.destroyAll(),c.markers.destroyAll(),c.levelNo=parseInt(b),c.arrangement=a,c.setupNodes(a),c.setupConnectors(a),c.resetSprites(a)},setupNodes:function(b){var c=this;a.each(b.nodes,function(b){require([b.modelModule],function(d){var e=a.extend({},b,{board:c}),f=new d(e);c.nodes.add(f)})})},nodeAdded:function(a){require([a.get("viewModule")],function(b){var c=new b({model:a})})},setupConnectors:function(b){var c=this;a.each(b.connections,function(b){var d=c.nodes.find(function(a){return a.get("nodeId")==b.from}),e=c.nodes.find(function(a){return a.get("nodeId")==b.to}),f=new i(a.extend({},b,{startNode:d,endNode:e,canDelete:!1}));f.coords.add({x:d.get("x"),y:d.get("y")}),f.coords.add({x:e.get("x"),y:e.get("y")});var g=new k({model:f,board:c});c.connectors.add(f),d.startConnectors.add(f)})},connectorStart:function(a){if(a.startConnectors.length>0)return!1;var b=a.tryConnectorStart();b!=null&&(p=new k({model:b,board:this}),this.dispatcher.trigger("connectorStarted"))},connectorEnd:function(a){return p==null?!1:a.endConnectors.length>0?!1:a.tryConnectorEnd(p.model)?(this.connectors.add(p.model),p=null,this.dispatcher.trigger("connectorEnded"),!0):!1},connectorAdded:function(a){var b=c.getPointPath(a.get("path"));a.set("pointPath",b.path)},touchEnd:function(a){if(p==null)return;var b=a.originalEvent.changedTouches[0].clientX,c=a.originalEvent.changedTouches[0].clientY,d=this.paper.getElementByPoint(b,c);if(d==null||d.node.id=="")return;var e=this.nodes.find(function(a){return a.get("nodeId")==d.node.id});this.connectorEnd(e)&&(a.stopPropagation(),a.preventDefault())},cursorMove:function(a){if(p!=null){var b=a.pageX||a.originalEvent.touches[0].pageX,c=a.pageY||a.originalEvent.touches[0].pageY,d=b-this.offset.left,e=c-this.offset.top;p.model.coords.add({x:d,y:e})}},cursorUp:function(a){p!=null&&(p.model.destroy(),this.dispatcher.trigger("connectorCancelled"),p=null)},checkSpriteRelease:function(){var a=this;this.releaseCount%e.releaseRate===0&&this.dispatcher.trigger("releaseSprite"),this.releaseCount++},start:function(){var a=this;a.timer!=null&&clearInterval(a.timer),a.resetSprites(a.arrangement),a.working=!1,a.timer=setInterval(function(){a.stepSprites()},e.timeout)},stepSprites:function(){var a=this;if(this.finishedSprites.length==this.spriteCount)return;this.checkSpriteRelease(),this.activeSprites.each(function(a){a.increment()})},resetSprites:function(a){var b=this;b.allSprites.destroyAll(),b.releaseCount=0,b.dispatcher.trigger("createSprites"),b.spriteCount=b.allSprites.length,b.finishedSpritesAreValid=!0},addSprite:function(b,c,d){var e=this,f=new l(a.extend(c,{fill:d}));b.startSprites.add(f),e.allSprites.add(f);var g=new n({model:f,board:e})},addMarker:function(b,c){var d=a.extend({},b,{fill:"none",stroke:c,"stroke-width":3,r:14,board:this}),e=new f(d);this.markers.add(e);var g=new h({model:e})},spriteFinished:function(a){var b=this,c=a.get("connector").get("endNode"),d=c.finishedSprites.indexOf(a);a.set(c.getSpriteEndPosition(d)),this.finishedSprites.length==this.spriteCount&&(clearInterval(this.timer),this.dispatcher.trigger("spritesFinished"),setTimeout(function(){if(b.finishedSpritesAreValid){alert("You Win!");var a=b.levelNo+1;a==e.levelCount&&(a=0);var c="level/"+a;b.navigate(c,{trigger:!0})}else alert("You Lose!")},50))}});return new q})